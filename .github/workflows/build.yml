name: Project Release Artifacts

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version without v prefix'
        required: false
      draft:
        description: 'Create release as draft'
        required: false
        type: boolean
        default: true

jobs:
  validate-acyclic-dependencies:
    name: Validate _classes Graph is Acyclic
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      - run: flutter pub get
      - run: dart pub global activate lakos
      - name: Enforce no cycles in _classes graph
        run: $HOME/.pub-cache/bin/lakos --no-cycles-allowed lib/_classes

  release:
    name: Create Release Page
    runs-on: ubuntu-latest
    needs:
      - validate-acyclic-dependencies
    outputs:
      version: ${{ steps.meta.outputs.version }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      build_number: ${{ steps.meta.outputs.build_number }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set Release Metadata
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION_INPUT="${{ github.event.inputs.version }}"
            if [ -z "$VERSION_INPUT" ]; then
              VERSION_INPUT="0.0.0-dev.${{ github.run_number }}"
            fi
            echo "version=$VERSION_INPUT" >> $GITHUB_OUTPUT
            echo "release_draft=${{ github.event.inputs.draft || 'true' }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "release_draft=false" >> $GITHUB_OUTPUT
          fi
          echo "build_number=$(git rev-list --count HEAD)" >> $GITHUB_OUTPUT

      - name: Create Release Page
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.meta.outputs.version }}
          target_commitish: ${{ github.sha }}
          release_name: Release ${{ steps.meta.outputs.version }}
          draft: ${{ steps.meta.outputs.release_draft == 'true' }}
          prerelease: false

  build:
    name: Create ${{ matrix.target }} build
    runs-on: ${{ matrix.os }}
    needs: release
    strategy:
      fail-fast: false
      matrix:
        target: [Web]
        include:
          - os: ubuntu-latest
            target: Web
            build_path: build/web/
            asset_extension: .tar.gz
            asset_content_type: application/gzip

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      - run: flutter pub get

      - name: Patch PubSpec
        run: dart run grinder pubspec-update --build-name=${{ needs.release.outputs.version }} --build-number=${{ needs.release.outputs.build_number }}

# Web
      - name: Build Web Package
        if: matrix.target == 'Web'
        run: flutter build -v web --release --no-tree-shake-icons --base-href="/app/finance/"

      - name: Compress Web Package
        if: matrix.target == 'Web'
        run: tar czf $GITHUB_WORKSPACE/fingrom_${{ matrix.target }}${{ matrix.asset_extension }} *
        working-directory: ${{ matrix.build_path }}

#
      - name: Upload ${{ matrix.target }} Artifact
        id: upload_release_asset
        uses: actions/upload-release-asset@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.release.outputs.upload_url }}
          asset_path: ./fingrom_${{ matrix.target }}${{ matrix.asset_extension }}
          asset_name: fingrom_${{ matrix.target }}${{ matrix.asset_extension }}
          asset_content_type: ${{ matrix.asset_content_type }}

# Linux
  build-linux:
    uses: ./.github/workflows/build_package_linux.yml
    if: success()
    needs:
      - release
    with:
      version: ${{ needs.release.outputs.version }}
      build_number: ${{ needs.release.outputs.build_number }}
      upload_url: ${{ needs.release.outputs.upload_url }}
      is_release: true

# Linux Flatpak
  build-flatpak:
    uses: ./.github/workflows/build_package_flatpak.yml
    if: success()
    needs:
      - release
      - build-linux
    secrets: inherit
    with:
      version: ${{ needs.release.outputs.version }}
      sha: ${{ github.sha }}
      upload_url: ${{ needs.release.outputs.upload_url }}
      is_release: true

# Linux AppImage
  build-appimage:
    uses: ./.github/workflows/build_package_appimage.yml
    if: success()
    needs:
      - release
      - build-linux
    secrets: inherit
    with:
      version: ${{ needs.release.outputs.version }}
      upload_url: ${{ needs.release.outputs.upload_url }}
      is_release: true
